---
id: 8
title: Rubyのメタプログラミング本を読む 1日目
created_at: 2022-01-30
updated_at: 2022-01-30
description: Rubyのメタプログラミング本を読んだ時のメモ的な何か
tags: Ruby
---

最近、Rubyを使う機会が出てきたので、前から気になっていたRubyのメタプログラミングに関する本を読んだ際のメモをまとめました。

[メタプログラミングRuby 第2版](https://www.oreilly.co.jp/books/9784873117430/)

メタプログラミングとは

*「言語要素を実行時に操作するコードを記述すること」*

を指すらしい。身近なとこでいうとActiveRecordで`ActiveRecord::Base`を継承するだけでアクセサメソッドが使えるようになるのは、各アトリビュートにアクセサメソッドを生やす操作を行なっているのでメタプログラミングの一種みたい。

CやC++とは異なり、Rubyの実行時にはほとんどの言語要素が存在するためメタプログラミングに適している。

## オープンクラス

文字列を修飾したい場面があったとする。

```ruby
def to_alphanumeric(s)
	s.gsub(/[^\w\s]/. '')
end
```

これではオブジェクト指向っぽくない。

この`to_alphanumeric`メソッドは全ての文字列に使用できるため、Stringクラス自体にこのメソッドを生やしてしまう。

```ruby
class String
	def to_alphanumeric
		gsub(/[^\w\s]/. '')
	end
end
```

これでいける。

Rubyにおけるclassはクラス宣言というよりかはスコープ演算子のようなものであり、クラスを複数個記載してもクラスの再定義が行われるのではなく、クラスのコンテキストに入り、メソッドの追加等の操作が行われるだけ。

上の例のように既存のクラスを再オープンして修正を行う技法を*オープンクラス*と呼ぶ。

（既存クラスへ安易なパッチを当てることは*モンキーパッチ*という蔑称で呼ばれることもあるとのこと）

## オブジェクトモデル

メタプログラミングを始めるにあたって、Rubyで採用されている全ての言語要素が共存するシステムであるオブジェクトモデルについて理解する必要がある。

変数やメソッドは以下のような住み分けをしている。

- オブジェクト: インスタンス変数が所属
- クラス: インスタンスメソッドやクラスメソッドが所属

オブジェクトモデルでは *「クラスはオブジェクト」* という考え方が大事になる。

Rubyでは、Classクラスのインスタンスはオブジェクトでありクラスそのものとなる（ArrayとかStringとか）。

他言語ではこのオブジェクト（Classクラスのインスタンス）からは情報を読み取ることしかできないが、Rubyでは実行時に書き込みを行うこともできる。

ClassクラスはModuleクラスのサブクラスであり、Classクラスのインスタンスメソッドにはよく使われるであろうnew等のメソッドが含まれている。

## ネームスペース

```ruby
my_class = MyClass
```

これはどちらもClassクラスのインスタンスの参照となる。

クラスはオブジェクトであり、クラス名は定数となる。

Rubyの定数はネストできる。

この特性を利用して、定数をmodule内に入れ衝突を避ける技法は*ネームスペース*と呼ばれる。

## メソッド呼び出し

次はメソッド呼び出しは

メソッド探索 → メソッド実行

の順に呼び出される。

以下新しい単語

- レシーバ: メソッド呼び出し元のオブジェクト
- 継承チェーン: クラスからスーパークラスへ見る場所を移動する

### メソッド探索とは？

*「レシーバのクラスに入り、メソッドが定義されている箇所まで継承チェーンを繰り返すこと」*

モジュールも継承チェーンに含まれ、モジュールを`include`した場合、`include`したクラスの上に挿入される。

`prepend`を用いると上ではなく下に挿入できる。

### メソッド実行とは？

*「レシーバをselfにしてメソッドを呼び出すこと」*

## refinements

オープンクラスはグローバルを汚染する。`refinements`を使えば、オープンクラスの影響範囲を制限できる。

やり方は、module定義内で`refine`を呼び出すだけ。

```ruby
module StringExtensions
	refine String do
		def to_alphanumeric
			gsub(/[^\w\s]/. '')
		end
	end
end
```

`refinements`は定義しただけでは使えない。

```ruby
using StringExtensions
```

というように`using`を呼び出した時点からファイルの最後まで使用できる。

module内で呼び出すとmodule内部のみで使用可能となる。

今日はこれで終了。